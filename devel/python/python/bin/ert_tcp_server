#!/usr/bin/env python
import sys
import time
import socket
from ert.server import ErtSocket

if len(sys.argv) < 3:
    sys.exit("\nUsage:\n   ert_tcp_server   config_file   port\n")

config_file = sys.argv[1]
port = int(sys.argv[2])
if len(sys.argv) >= 4:
   host = sys.argv[3]
else:
   host = "localhost"


timeout    = 60
sleep_time = 5
start_time = time.time()
while True:
    try:
        ert_socket = ErtSocket(config_file , port, host)
        print "\nERT Server is accepting connections on port:%d => " % port,
        sys.stdout.flush()
        break
    except socket.error:
        print "FAILED to start ErtServer: Will retry in %d seconds ... " % sleep_time,
        sys.stdout.flush()
        if time.time() - start_time > 60:
            sys.exit("Failed to open ERT handle to:%s " % config_file)

        time.sleep( sleep_time )
        print 



status = ert_socket.evalCmd(["STATUS"])
if status[0] == "READY":
    ert_socket.listen()
else:
    sys.exit("Failed to open ERT handle to:%s " % config_file)

